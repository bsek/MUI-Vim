#------------------------------------------------------------------------------------------
# Naming and paths
#------------------------------------------------------------------------------------------
VIM:=Vim
SRC:=src
NST:=installer
UNM:=$(shell uname)
ARC:=$(shell uname -m | tr -d ower)

ifeq ($(UNM),MorphOS)
ANM:=$(ARC)-morphos
LHO:=-3rae
else ifeq ($(UNM),AmigaOS4)
ANM:=$(ARC)-amigaos
else ifeq ($(UNM),AROS)
ANM:=$(ARC)-aros
endif

#------------------------------------------------------------------------------------------
# Build Vim
#------------------------------------------------------------------------------------------
$(SRC)/vim: $(SRC)/.ver $(SRC)/.pat
	$(MAKE) -C $(SRC) -f Make_ami.mak PATCHLEVEL=`cat $(SRC)/.pat`

#------------------------------------------------------------------------------------------
# Determine version
#------------------------------------------------------------------------------------------
$(SRC)/.ver: $(SRC)/version.h
	grep "#.\{1,\}_SHORT" $< | sed -e "s/.*\"\([0-9]\.[0-9]\)\".*/\1/" > $@

#------------------------------------------------------------------------------------------
# Determine patch number
#------------------------------------------------------------------------------------------
$(SRC)/.pat: $(SRC)/version.c
	grep -m1 "^ \{4\}[0-9]\{1,4\},$$" $< | tr -d "[:space:]," > $@

#------------------------------------------------------------------------------------------
# Phony standard targets
#------------------------------------------------------------------------------------------
.PHONY: clean
clean:
	$(MAKE) -C $(NST) $@
	$(MAKE) -C $(SRC) -f Make_ami.mak $@
	rm -Rf *.lha $(SRC)/.pat $(SRC)/.ver .arc
