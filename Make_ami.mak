#------------------------------------------------------------------------------------------
# General settings
#------------------------------------------------------------------------------------------
SRC:=src
DST:=dist
MKF:=Make_ami.mak
VER=$(shell cat $(SRC)/.ver)
REV=$(shell cat $(SRC)/.pat)

#------------------------------------------------------------------------------------------
# Build Vim
#------------------------------------------------------------------------------------------
.PHONY: vim
vim: $(SRC)/.ver $(SRC)/.pat
	$(MAKE) -C $(SRC) -f $(MKF) PATCHLEVEL=$(REV)

#------------------------------------------------------------------------------------------
# Create archive
#------------------------------------------------------------------------------------------
.PHONY: $(DST)
$(DST): vim
	$(MAKE) -C $(DST) VER=$(VER) REV=$(REV)

#------------------------------------------------------------------------------------------
# Determine version
#------------------------------------------------------------------------------------------
$(SRC)/.ver: $(SRC)/version.h
	grep -E "#.\{1,\}_SHORT" $< | tr -d "[:space:][:alpha:]#_\"" > $@

#------------------------------------------------------------------------------------------
# Determine patch number
#------------------------------------------------------------------------------------------
$(SRC)/.pat: $(SRC)/version.c
	grep -E -m1 "^ \{4\}[0-9]\{1,4\},$$" $< | tr -d "[:space:]," > $@

#------------------------------------------------------------------------------------------
# Clean up
#------------------------------------------------------------------------------------------
.PHONY: clean
clean:
	$(MAKE) -C $(DST) $@
	$(MAKE) -C $(SRC) -f $(MKF) $@
	rm -f $(SRC)/.pat $(SRC)/.ver
